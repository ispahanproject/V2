<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-SA MAP (Situational Awareness)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- DARK COCKPIT THEME --- */
        :root { 
            --bg: #050505; --panel: rgba(20, 20, 20, 0.95); --border: #444;
            --volcano: #ff3333; --peak: #FFBF00; /* Amber */ --hold: #00ffff;
            --apt: #ffffff; --vor: #00ff00; --ndb: #ff00ff;
        }
        body, html { margin:0; padding:0; height:100%; background:var(--bg); font-family:'Consolas',monospace; overflow:hidden; }
        #map { height:100%; width:100%; background:#0a0a0a; }

        /* Header Info */
        .status-bar {
            position: absolute; top: 15px; left: 60px; z-index: 1000;
            background: var(--panel); border: 1px solid var(--border); 
            padding: 8px 15px; border-radius: 4px; pointer-events: none;
            color: #00ff00; font-size: 14px; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
        }

        /* --- ICONS --- */
        /* Terrain (VFR Chart Style - Name Emphasized) */
        .terrain-marker-container { 
            display: flex; align-items: center; pointer-events: none; 
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; 
        }
        .terrain-symbol { font-size: 18px; line-height: 1; margin-right: 4px; }
        .terrain-info { display: flex; flex-direction: column; line-height: 1.0; }
        
        /* åå‰ã‚’å¤§ããã€æ¨™é«˜ã‚’å°ã•ãå¤‰æ›´ */
        .terrain-name { font-size: 14px; font-weight: bold; white-space: nowrap; letter-spacing: 0.5px; }
        .terrain-alt { font-size: 11px; font-weight: normal; opacity: 0.9; }
        
        .color-volcano { color: var(--volcano); }
        .color-peak { color: var(--peak); } /* Amber */

        /* Holding Pattern */
        .hold-icon {
            display: flex; align-items: center; justify-content: center;
            border: 1.5px solid var(--hold); border-radius: 12px;
            background: rgba(0, 50, 50, 0.6); color: var(--hold);
            font-size: 10px; font-weight: bold; white-space: nowrap;
            transition: 0.2s; box-shadow: 0 0 5px rgba(0,255,255,0.3);
        }
        .hold-icon:hover { background: rgba(0, 255, 255, 0.2); z-index: 9999; cursor: pointer; }

        /* NAVAIDS (Simple geometric shapes) */
        .nav-icon-apt {
            width: 10px; height: 10px; border: 2px solid var(--apt); border-radius: 50%;
            background: #000; box-shadow: 0 0 4px var(--apt);
        }
        .nav-icon-vor {
            width: 12px; height: 12px; border: 2px solid var(--vor); 
            background: #000; transform: rotate(45deg); /* Diamond/Square */
        }
        .nav-icon-ndb {
            width: 8px; height: 8px; border: 1px dotted var(--ndb); border-radius: 50%;
            background: transparent;
        }
        
        /* Labels for NAVAIDS (Permanent Display when Layer Active) */
        .nav-label {
            font-size: 10px !important; 
            color: #fff !important; 
            background: transparent !important; 
            border: none !important;
            box-shadow: none !important;
            text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
            white-space: nowrap;
            margin-left: 5px; /* ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã®è·é›¢ */
        }
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { border: none !important; }

        /* --- LEAFLET LAYER CONTROL (FILTER PANEL) STYLING v2 --- */
        
        /* 1. ãƒ‘ãƒãƒ«å…¨ä½“ã®ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .leaflet-control-layers {
            background: rgba(12, 16, 20, 0.95) !important; /* ã‚ˆã‚Šæ·±ã„é»’ */
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(0, 229, 255, 0.4) !important; /* æ ç·šã‚’å°‘ã—æ˜ã‚‹ã */
            border-radius: 4px !important;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1) !important;
            color: #e0e0e0 !important;
            font-family: 'Consolas', 'Monaco', monospace !important;
            transition: all 0.3s ease;
        }

        /* 2. å±•é–‹æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-control-layers-expanded {
            padding: 15px 18px !important;
            min-width: 200px; /* å°‘ã—å¹…ã‚’åºƒã’ã‚‹ */
        }

        /* 3. å„é …ç›®ã®è¡Œã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ•ã‚©ãƒ³ãƒˆä¿®æ­£ï¼‰ */
        .leaflet-control-layers label {
            display: flex !important;
            align-items: center;
            margin-bottom: 8px; /* è¡Œé–“ã‚’å°‘ã—åºƒã’ã‚‹ */
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            
            /* â˜… ãƒ•ã‚©ãƒ³ãƒˆã‚’ãŠã—ã‚ƒã‚Œã«ã™ã‚‹è¨­å®š â˜… */
            font-size: 12px;
            font-weight: 600;        /* å¤ªã */
            letter-spacing: 1.5px;   /* æ–‡å­—é–“ã‚’åºƒã’ã‚‹ */
            text-transform: uppercase; /* å¤§æ–‡å­—ã«çµ±ä¸€ */
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.2); /* ã»ã®ã‹ãªç™ºå…‰ */
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .leaflet-control-layers label:hover {
            background: rgba(0, 229, 255, 0.15);
            color: #fff !important;
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.6); /* ãƒ›ãƒãƒ¼æ™‚ã«å…‰ã‚‰ã›ã‚‹ */
            transform: translateX(3px); /* å°‘ã—å³ã«å‹•ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        /* 4. ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .leaflet-control-layers-selector {
            margin-top: 0 !important;
            margin-right: 12px !important;
            accent-color: #00e5ff;
            cursor: pointer;
            width: 14px;
            height: 14px;
            opacity: 0.8;
        }

        /* 5. ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ç·š */
        .leaflet-control-layers-separator {
            border-top: 1px dashed rgba(255, 255, 255, 0.15) !important;
            margin: 10px 0 !important;
        }

        /* River Style */
        .river-marker-container { 
            display: flex; flex-direction: column; align-items: center; 
            pointer-events: none; text-shadow: 1px 1px 0 #000;
        }
        .river-symbol { font-size: 14px; color: #4488ff; font-weight: bold; }
        .river-name { font-size: 10px; color: #4488ff; font-weight: bold; white-space: nowrap; }

        /* LAKE Style */
        .color-lake { color: #00BFFF; } /* DeepSkyBlue */
        
        .lake-marker-container { 
            display: flex; flex-direction: column; align-items: center; 
            pointer-events: none; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
        }
        .lake-symbol { font-size: 16px; margin-bottom: -4px; }
        .lake-name { font-size: 11px; font-weight: bold; font-style: italic; white-space: nowrap; }
    </style>
</head>
<body>

    <a href="../index.html" style="
    position: absolute; top: 15px; left: 15px; z-index: 2000;
    background: rgba(16, 20, 24, 0.85);
    border: 1px solid #00e5ff; border-radius: 4px;
    color: #00e5ff; text-decoration: none;
    padding: 6px 12px; font-weight: bold; font-size: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
">ğŸ </a>

    <div class="status-bar">J-SA INTEGRATED MAP</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="../js/terrain_db.js"></script>
    <script src="../js/holding_points.js"></script>
    <script src="../js/navaids.js"></script>
    <script src="../js/route_db.js"></script>
    <script src="../js/airway_db.js"></script>

    <script>
        // 1. Initialize Map
        const map = L.map('map', { 
            center: [35.5, 138.0], 
            zoom: 6, 
            zoomControl: false,
            preferCanvas: true 
        });
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        // 2. Define Layers
        // åˆæœŸè¡¨ç¤ºè¨­å®š: AIRPORTã¨HOLDINGã€ROUTEã®ã¿ .addTo(map) ã‚’ä»˜ã‘ã‚‹
        const layers = {
            volcano: L.layerGroup(),            // OFF
            peak:    L.layerGroup(),            // OFF
            lake:    L.layerGroup(),            // OFF
            river:   L.layerGroup(),            // OFF
            hold:    L.layerGroup().addTo(map), // â˜…ON (åˆæœŸè¡¨ç¤º)
            apt:     L.layerGroup().addTo(map), // â˜…ON (åˆæœŸè¡¨ç¤º)
            vor:     L.layerGroup(),            // OFF
            ndb:     L.layerGroup(),            // OFF
        
        };

        // --- LOAD TERRAIN (Volcano/Peak) ---
        if(typeof TERRAIN_DB !== 'undefined') {
            for(let key in TERRAIN_DB) {
                const t = TERRAIN_DB[key];
                const isVolcano = (t.type === 'VOLCANO');
                const colorClass = isVolcano ? 'color-volcano' : 'color-peak';
                
                // HTMLæ§‹é€ : åå‰ã‚’ä¸Šã«ã€æ¨™é«˜ã‚’ä¸‹ã«é…ç½®ã—ã¦å¼·èª¿
                const iconHtml = `
                    <div class="terrain-marker-container">
                        <div class="terrain-symbol ${colorClass}">â–²</div>
                        <div class="terrain-info">
                            <span class="terrain-name ${colorClass}">${key}</span>
                            <span class="terrain-alt ${colorClass}">${t.alt}</span>
                        </div>
                    </div>`;
                
                const marker = L.marker([t.lat, t.lon], {
                    icon: L.divIcon({ className: '', html: iconHtml, iconSize: [120,35], iconAnchor: [10,18] })
                }).bindTooltip(`${key}: ${t.alt}ft`, { direction:'top', offset:[0,-15], opacity:0 }); // Tooltipã¯è£œåŠ©ç”¨(éè¡¨ç¤ºæ°—å‘³)

                marker.minZoom = t.min_zoom || 6;
                marker.addTo(isVolcano ? layers.volcano : layers.peak);
            }
        }

        // --- LOAD LAKES (â˜…æ–°è¦è¿½åŠ ) ---
        if(typeof LAKE_DB !== 'undefined') {
            for(let key in LAKE_DB) {
                const l = LAKE_DB[key];
                // æ¹–ã®ã‚¢ã‚¤ã‚³ãƒ³: æ°´è‰²ã®è±å½¢ã‚„æ³¢ç·šã€ã‚ã‚‹ã„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«åå‰
                const iconHtml = `
                    <div class="lake-marker-container color-lake">
                        <div class="lake-name">${key}</div>
                        <div style="font-size:9px; opacity:0.8;">(${l.elev}ft)</div>
                    </div>`;
                
                const marker = L.marker([l.lat, l.lon], {
                    icon: L.divIcon({ className: '', html: iconHtml, iconSize: [100,30], iconAnchor: [50,15] })
                });

                marker.minZoom = l.min_zoom || 6;
                marker.addTo(layers.lake);
            }
        }

        // --- LOAD HOLDING PATTERNS ---
        if(typeof HOLDING_DB !== 'undefined') {
            for(let key in HOLDING_DB) {
                const h = HOLDING_DB[key];
                L.marker([h.lat, h.lon], {
                    icon: L.divIcon({ className: 'hold-icon', html: `â¬­ ${key}`, iconSize: [60,20] })
                }).bindPopup(`
                    <div class="popup-header">${key} HOLD</div>
                    <div class="data-row"><span>INBD:</span> <b>${h.inbound}Â°</b></div>
                    <div class="data-row"><span>TURN:</span> <b style="color:${h.turn==='RIGHT'?'#0f0':'#f0f'}">${h.turn}</b></div>
                    <div class="data-row"><span>MHA:</span> <b style="color:#ffaa00">${h.mha}</b></div>
                    <div class="data-row"><span>LEG:</span> <span>${h.leg || '-'}</span></div>
                    <div class="data-row"><span>MAX SPD:</span> <span>${h.max_ias ? h.max_ias+'kt' : '-'}</span></div>
                `).addTo(layers.hold);
            }
        }

        // --- LOAD NAVAIDS & AIRPORTS (from navaids.js) ---
        if(typeof NAV_DB !== 'undefined') {
            for(let key in NAV_DB) {
                const data = Array.isArray(NAV_DB[key]) ? NAV_DB[key][0] : NAV_DB[key];
                if(!data.lat || !data.lon) continue;

                let layerTarget = null;
                let iconClass = '';
                let zIndexOffset = 0;
                let labelColor = '#fff';

                if (data.type === 'APT') {
                    layerTarget = layers.apt;
                    iconClass = 'nav-icon-apt';
                    zIndexOffset = 1000;
                } else if (data.type === 'VOR' || data.type === 'VORTAC') {
                    layerTarget = layers.vor;
                    iconClass = 'nav-icon-vor';
                    labelColor = '#00ff00';
                } else if (data.type === 'NDB') {
                    layerTarget = layers.ndb;
                    iconClass = 'nav-icon-ndb';
                    labelColor = '#ff00ff';
                }

                if (layerTarget) {
                    const marker = L.marker([data.lat, data.lon], {
                        icon: L.divIcon({ className: iconClass, iconSize:null }),
                        zIndexOffset: zIndexOffset
                    });
                    
                    // ã€å¤‰æ›´ç‚¹ã€‘ permanent: true ã«ã—ã¦å¸¸æ™‚è¡¨ç¤ºã•ã›ã‚‹
                    marker.bindTooltip(key, { 
                        permanent: true, 
                        direction: 'right', 
                        offset: [12, 0], 
                        className: 'nav-label' 
                    });
                    
                    // ã‚¹ã‚¿ã‚¤ãƒ«å¾®èª¿æ•´ï¼ˆTooltipã®è‰²ã‚’ç¨®åˆ¥ã”ã¨ã«å¤‰ãˆã‚‹å ´åˆï¼‰
                    // marker.on('add', function() { this.getTooltip()._container.style.color = labelColor; });

                    marker.addTo(layerTarget);
                }
            }
        }

        // --- LOAD RIVERS (â˜…æ–°è¦è¿½åŠ ) ---
        if(typeof RIVER_DB !== 'undefined') {
            for(let key in RIVER_DB) {
                const r = RIVER_DB[key];
                // å·ã®ã‚¢ã‚¤ã‚³ãƒ³: é’ã„æ³¢ç·š(â‰ˆ)ã¨åå‰
                const iconHtml = `
                    <div class="river-marker-container">
                        <div class="river-symbol">â‰ˆ</div>
                        <div class="river-name">${key}</div>
                    </div>`;
                
                const marker = L.marker([r.lat, r.lon], {
                    icon: L.divIcon({ className: '', html: iconHtml, iconSize: [100,30], iconAnchor: [50,15] })
                }).bindTooltip(`${key}: ${r.remark}`, { direction:'top', offset:[0,-10], opacity:0.8 });

                marker.minZoom = r.min_zoom || 7;
                marker.addTo(layers.river);
            }
        }


        // 3. Layer Control (Stylish Labels)
        const overlays = {
            // TERRAIN Category
            "<span style='color:#ff3333;'>ğŸŒ‹ VOLCANO</span>": layers.volcano,
            "<span style='color:#FFBF00;'>ğŸ”ï¸ TERRAIN</span>": layers.peak,
            "<span style='color:#00BFFF;'>ğŸ’§ LAKES</span>": layers.lake,
            "<span style='color:#4488ff;'>â‰ˆ RIVERS</span>": layers.river,
            
            // AERONAUTICAL Category
            "<span style='color:#ffffff; font-weight:bold; border-left:3px solid #fff; padding-left:5px;'>âœˆï¸ AIRPORT</span>": layers.apt,
            "<span style='color:#00ffff;'>â¬­ HOLDING</span>": layers.hold,
            "<span style='color:#00ff00;'>â¬¡ VOR</span>": layers.vor,
            "<span style='color:#ff00ff;'>â— NDB</span>": layers.ndb
        };

        L.control.layers(null, overlays, { collapsed: true, position: 'topright' }).addTo(map);

        
        
        // 4. Zoom Level Decluttering Logic
        function updateMapDisplay() {
            const z = map.getZoom();
            [layers.volcano, layers.peak, layers.river].forEach(grp => {
                if(!map.hasLayer(grp)) return;
                grp.eachLayer(m => {
                    if (m.minZoom) {
                        const shouldShow = z >= m.minZoom;
                        if (m.getElement()) m.getElement().style.display = shouldShow ? 'block' : 'none';
                    }
                });
            });
        }

        map.on('zoomend', updateMapDisplay);
        map.on('layeradd', updateMapDisplay);
        updateMapDisplay(); 

        // ---------------------------------------------------------
        // 6. GPS / CURRENT LOCATION LOGIC (New)
        // ---------------------------------------------------------
        
        // GPSãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ç”¨ï¼‰
        const gpsLayer = L.layerGroup().addTo(map);

        // GPSãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
        L.Control.GPS = L.Control.extend({
            onAdd: function(map) {
                const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                
                // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
                btn.innerHTML = 'âŒ–'; // Target Icon
                btn.style.backgroundColor = 'rgba(16, 20, 24, 0.9)';
                btn.style.color = '#00e5ff';
                btn.style.fontSize = '22px';
                btn.style.fontWeight = 'bold';
                btn.style.width = '34px';
                btn.style.height = '34px';
                btn.style.lineHeight = '34px';
                btn.style.textAlign = 'center';
                btn.style.cursor = 'pointer';
                btn.style.border = '1px solid rgba(0, 229, 255, 0.5)';
                btn.style.borderRadius = '4px';
                btn.style.backdropFilter = 'blur(5px)';
                btn.title = "Show Current Location";

                // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
                btn.onclick = function() {
                    btn.innerHTML = '<span style="animation:blink 1s infinite">â—</span>'; // æ¤œç´¢ä¸­ã‚¢ãƒ‹ãƒ¡
                    map.locate({setView: true, maxZoom: 10, timeout: 10000});
                };
                return btn;
            }
        });

        // ãƒœã‚¿ãƒ³ã‚’åœ°å›³ã«è¿½åŠ ï¼ˆå³ä¸‹ï¼‰
        new L.Control.GPS({ position: 'bottomright' }).addTo(map);

        // ä½ç½®æƒ…å ±å–å¾—æˆåŠŸæ™‚ã®å‡¦ç†
        map.on('locationfound', function(e) {
            gpsLayer.clearLayers();
            
            // ç²¾åº¦å††ï¼ˆè–„ã„é’ï¼‰
            L.circle(e.latlng, {
                radius: e.accuracy / 2,
                color: '#00e5ff',
                fillColor: '#00e5ff',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(gpsLayer);

            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆé’ã„ãƒ‰ãƒƒãƒˆï¼‰
            L.circleMarker(e.latlng, {
                radius: 6,
                color: '#fff',
                fillColor: '#00e5ff',
                fillOpacity: 1,
                weight: 2
            }).bindPopup(`<b>CURRENT POSITION</b><br>Lat: ${e.latlng.lat.toFixed(4)}<br>Lon: ${e.latlng.lng.toFixed(4)}`).addTo(gpsLayer).openPopup();

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æˆ»ã™
            document.querySelector('.leaflet-control-gps').innerHTML = 'âŒ–';
        });

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆæ‹’å¦ã•ã‚ŒãŸå ´åˆãªã©ï¼‰
        map.on('locationerror', function(e) {
            alert("Location access denied or timeout.");
            document.querySelector('.leaflet-control-gps').innerHTML = 'âŒ–';
        });

        // ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
        const styleSheet = document.createElement("style");
        styleSheet.innerText = "@keyframes blink { 0% {opacity:1;} 50% {opacity:0.3;} 100% {opacity:1;} }";
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>