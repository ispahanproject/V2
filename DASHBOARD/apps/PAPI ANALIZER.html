<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adv. PAPI Analysis (4 RED Support)</title>
    <style>
        :root {
            --bg-color: #0f111a;
            --card-bg: #1b2336;
            --input-bg: #252e46;
            --text-color: #e0e6ed;
            --accent-color: #3a86ff;
            --highlight: #ff006e;
            --white: #ffffff;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 950px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--input-bg);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--white); }
        .badge {
            background: var(--accent-color);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* Grid Layout */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .control-group {
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #8d99ae;
        }
        /* Input with Unit Selector */
        .input-wrapper {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        input, select {
            background: rgba(0,0,0,0.3);
            border: 1px solid #4a5568;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1rem;
            box-sizing: border-box; 
        }
        input { flex-grow: 1; }
        select { width: 60px; text-align: center; cursor: pointer;}
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Results Area */
        .results {
            display: grid;
            /* 3 columns for White / 3 Red / 4 Red */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .result-card {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid;
            position: relative;
        }
        .res-white { border-color: #ffd700; }
        .res-red { border-color: #ef233c; }
        .res-dark-red { border-color: #880e4f; background: rgba(50, 0, 0, 0.3); }
        
        .res-title {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .res-value {
            font-family: monospace;
            font-size: 1.4rem;
            color: var(--white);
        }
        .res-sub {
            font-size: 0.8rem;
            color: #8d99ae;
        }

        /* Visualization */
        .viz-box {
            background: #000;
            border-radius: 8px;
            height: 350px;
            width: 100%;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }
        canvas { width: 100%; height: 100%; }

        .footer-note {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <a href="../index.html" style="
            text-decoration: none; color: var(--text-color); 
            font-size: 1.5rem; transition: 0.2s;
            display: flex; align-items: center;
        " onmouseover="this.style.color='#3a86ff'" onmouseout="this.style.color='var(--text-color)'">
            üè†
        </a>
        <h1>PAPI Indication Solver</h1>
    </div>
    <span class="badge">V1.3 (4 RED Support)</span>
</header>

    <div class="controls">
        <div class="control-group">
            <h3>Aircraft & GS</h3>
            <label>Eye-to-Antenna (EWH) [ft]</label>
            <div class="input-wrapper">
                <input type="number" id="ewh" value="15" step="1">
            </div>
            
            <label>GS Angle (GPA) [deg]</label>
            <div class="input-wrapper">
                <input type="number" id="gpa" value="3.00" step="0.01">
            </div>

            <label>TCH [ft]</label>
            <div class="input-wrapper">
                <input type="number" id="tch" value="50" step="1">
            </div>
        </div>

        <div class="control-group">
            <h3>Runway Env</h3>
            <label>PAPI Dist from THR</label>
            <div class="input-wrapper">
                <input type="number" id="papiDist" value="1350" step="10">
                <select id="papiUnit">
                    <option value="ft" selected>ft</option>
                    <option value="m">m</option>
                </select>
            </div>
            
            <label>Runway Slope [%]</label>
            <div class="input-wrapper">
                <input type="number" id="slope" value="0.0" step="0.1" placeholder="+Up/-Down">
            </div>
            <div style="font-size:0.7rem; color:#666; margin-top:-5px;">(+): Upslope (RWY End Higher)</div>
        </div>

        <div class="control-group">
            <h3>Atmosphere</h3>
            <label>SAT (Temp) [¬∞C]</label>
            <div class="input-wrapper">
                <input type="number" id="temp" value="15" step="1">
            </div>
            
            <label>Airport Elev [ft]</label>
            <div class="input-wrapper">
                <input type="number" id="aptElev" value="0" step="1">
            </div>
            <div style="font-size:0.7rem; color:#666; margin-top:-5px;">Affects Ind Alt Correction</div>
        </div>
    </div>

    <div class="results">
        <div class="result-card res-white">
            <span class="res-title" style="color:#ffd700;">3 WHITE (High) Starts</span>
            <div class="res-value" id="disp-white-alt">---</div>
            <div class="res-sub">Indicated Altitude (QNH)</div>
            <div class="res-sub" id="disp-white-dist" style="margin-top:5px;">at --- ft Distance</div>
        </div>
        <div class="result-card res-red">
            <span class="res-title" style="color:#ef233c;">3 RED (Low) Starts</span>
            <div class="res-value" id="disp-red-alt">---</div>
            <div class="res-sub">Indicated Altitude (QNH)</div>
            <div class="res-sub" id="disp-red-dist" style="margin-top:5px;">at --- ft Distance</div>
        </div>
        <div class="result-card res-dark-red">
            <span class="res-title" style="color:#e91e63;">4 RED (Very Low) Starts</span>
            <div class="res-value" id="disp-4red-alt">---</div>
            <div class="res-sub">Indicated Altitude (QNH)</div>
            <div class="res-sub" id="disp-4red-dist" style="margin-top:5px;">at --- ft Distance</div>
        </div>
    </div>

    <div class="viz-box">
        <canvas id="simCanvas"></canvas>
    </div>

    <div class="footer-note">
        <strong>Angle Definitions (based on GPA):</strong><br>
        - <strong>3 WHT:</strong> GPA + 10' (e.g. 3.17¬∞)<br>
        - <strong>3 RED:</strong> GPA - 10' (e.g. 2.83¬∞)<br>
        - <strong>4 RED:</strong> GPA - 30' (e.g. 2.50¬∞) -> Critical Obstacle Protection Boundary
    </div>
</div>

<script>
    // --- Configuration & Constants ---
    const FT_PER_M = 3.28084;
    
    // --- DOM Elements ---
    const ui = {
        ewh: document.getElementById('ewh'),
        gpa: document.getElementById('gpa'),
        tch: document.getElementById('tch'),
        papiDist: document.getElementById('papiDist'),
        papiUnit: document.getElementById('papiUnit'),
        slope: document.getElementById('slope'),
        temp: document.getElementById('temp'),
        aptElev: document.getElementById('aptElev'),
        
        outW_Alt: document.getElementById('disp-white-alt'),
        outW_Dist: document.getElementById('disp-white-dist'),
        outR_Alt: document.getElementById('disp-red-alt'),
        outR_Dist: document.getElementById('disp-red-dist'),
        out4R_Alt: document.getElementById('disp-4red-alt'),
        out4R_Dist: document.getElementById('disp-4red-dist'),
        
        canvas: document.getElementById('simCanvas')
    };

    // --- State & Events ---
    const ctx = ui.canvas.getContext('2d');
    
    // Attach listeners
    Object.values(ui).forEach(el => {
        if(el.tagName === 'INPUT' || el.tagName === 'SELECT') {
            el.addEventListener('input', updateSimulation);
        }
    });
    window.addEventListener('resize', updateSimulation);

    // --- Math Kernel ---
    function updateSimulation() {
        // 1. Gather Inputs
        let rawDist = parseFloat(ui.papiDist.value) || 1000;
        let distUnit = ui.papiUnit.value;
        let distFt = (distUnit === 'm') ? rawDist * FT_PER_M : rawDist;

        const params = {
            ewh: parseFloat(ui.ewh.value) || 0,
            gpa: parseFloat(ui.gpa.value) || 3.0,
            tch: parseFloat(ui.tch.value) || 50,
            papiDist: distFt, // Feet
            slope: parseFloat(ui.slope.value) || 0.0,
            temp: parseFloat(ui.temp.value) || 15,
            aptElev: parseFloat(ui.aptElev.value) || 0
        };

        // 2. Define Angles (ICAO Annex 14)
        // Unit 1 (4 RED): A - 30'
        // Unit 2 (3 RED): A - 10'
        // Unit 3 (3 WHT): A + 10'
        const radGPA = toRad(params.gpa);
        const radHigh = toRad(params.gpa + 10/60); // 3 White
        const radLow = toRad(params.gpa - 10/60);  // 3 Red
        const radVeryLow = toRad(params.gpa - 30/60); // 4 Red

        // 3. Solve Geometry
        const papiBaseElev = params.papiDist * (params.slope / 100);

        function solve(limitAngleRad) {
            const num = (params.papiDist * Math.tan(limitAngleRad)) + papiBaseElev - params.tch - params.ewh;
            const den = Math.tan(radGPA) - Math.tan(limitAngleRad);
            
            if (Math.abs(den) < 1e-6) return null; // Parallel
            
            const dist = num / den; // Distance from THR
            const trueAlt = dist * Math.tan(radGPA) + params.tch + params.ewh; // True height above THR
            
            return { dist, trueAlt };
        }

        const resHigh = solve(radHigh);
        const resLow = solve(radLow);
        const resVeryLow = solve(radVeryLow);

        // 4. Temp Correction
        function getIndicated(trueH) {
            if (trueH === null) return null;
            const tStd = 288.15; 
            const tAct = 273.15 + params.temp;
            const ratio = tStd / tAct;
            const indHeight = trueH * ratio;
            return indHeight + params.aptElev;
        }

        // Helper for UI update
        function updateUI(res, elAlt, elDist, checkNegative=true) {
            // checkNegative: if true, ignore negative distances (behind THR)
            // However, for 4RED it might be useful to know if it's strictly impossible
            if (res && res.dist > 0) {
                const ind = getIndicated(res.trueAlt);
                elAlt.textContent = Math.round(ind) + " ft";
                elDist.textContent = `at ${Math.round(res.dist)} ft Dist`;
            } else {
                elAlt.textContent = "NONE";
                elDist.textContent = "Geometry OK";
            }
        }

        // 3 White
        if (resHigh && resHigh.dist > -2000) { 
             const ind = getIndicated(resHigh.trueAlt);
             ui.outW_Alt.textContent = Math.round(ind) + " ft";
             ui.outW_Dist.textContent = `at ${Math.round(resHigh.dist)} ft Dist`;
             ui.outW_Alt.style.color = (params.temp < 0) ? "#06d6a0" : "#ffffff";
        } else {
             ui.outW_Alt.textContent = "N/A";
             ui.outW_Dist.textContent = "-";
        }

        // 3 Red & 4 Red
        updateUI(resLow, ui.outR_Alt, ui.outR_Dist);
        updateUI(resVeryLow, ui.out4R_Alt, ui.out4R_Dist);

        // 6. Draw Visualization
        drawViz(params, resHigh, resLow, resVeryLow, papiBaseElev);
    }

    // --- Visualization Engine ---
    function drawViz(p, rHigh, rLow, rVeryLow, papiElev) {
        const w = ui.canvas.parentElement.clientWidth;
        const h = ui.canvas.parentElement.clientHeight;
        ui.canvas.width = w;
        ui.canvas.height = h;

        const scaleX_Max = 20000; 
        const scaleX_Min = -3000; 
        const rangeX = scaleX_Max - scaleX_Min;
        const scaleY_Max = 1200; 
        
        function tX(ft) { return ((ft - scaleX_Min) / rangeX) * w; }
        function tY(ft) { return h - (ft / scaleY_Max) * h; }

        ctx.clearRect(0,0,w,h);

        // Ground
        ctx.strokeStyle = "#666";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(tX(scaleX_Min), tY(-scaleX_Min * (p.slope/100)));
        ctx.lineTo(tX(scaleX_Max), tY(-scaleX_Max * (p.slope/100)));
        ctx.stroke();

        // THR
        ctx.strokeStyle = "#fff";
        ctx.setLineDash([5,5]);
        ctx.beginPath();
        ctx.moveTo(tX(0), 0);
        ctx.lineTo(tX(0), h);
        ctx.stroke();
        ctx.fillStyle = "#fff";
        ctx.fillText("THR", tX(0)+5, h-10);

        // PAPI Unit
        const px = tX(-p.papiDist);
        const py = tY(papiElev); 
        ctx.fillStyle = "#ff006e";
        ctx.fillRect(px-4, py-4, 8, 8);
        ctx.fillText("PAPI", px-10, py-15);

        // Beams
        const radHigh = toRad(p.gpa + 10/60);
        const radLow = toRad(p.gpa - 10/60);
        const radVeryLow = toRad(p.gpa - 30/60);
        
        // High (3W)
        ctx.strokeStyle = "rgba(255, 215, 0, 0.3)";
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(px, py);
        ctx.lineTo(tX(scaleX_Max), tY((scaleX_Max + p.papiDist)*Math.tan(radHigh) + papiElev));
        ctx.stroke();

        // Low (3R)
        ctx.strokeStyle = "rgba(239, 35, 60, 0.5)"; // Red
        ctx.beginPath();
        ctx.moveTo(px, py);
        ctx.lineTo(tX(scaleX_Max), tY((scaleX_Max + p.papiDist)*Math.tan(radLow) + papiElev));
        ctx.stroke();

        // Very Low (4R)
        ctx.strokeStyle = "rgba(136, 14, 79, 0.8)"; // Dark Red
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(px, py);
        ctx.lineTo(tX(scaleX_Max), tY((scaleX_Max + p.papiDist)*Math.tan(radVeryLow) + papiElev));
        ctx.stroke();
        ctx.lineWidth = 1;
        ctx.fillStyle = "rgba(136, 14, 79, 0.8)";
        ctx.fillText("4 RED Line", tX(scaleX_Max)-60, tY((scaleX_Max + p.papiDist)*Math.tan(radVeryLow) + papiElev)-5);

        // GS Path
        const radGS = toRad(p.gpa);
        ctx.strokeStyle = "#3a86ff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        const yStart = scaleX_Min * Math.tan(radGS) + p.tch + p.ewh;
        const yEnd = scaleX_Max * Math.tan(radGS) + p.tch + p.ewh;
        ctx.moveTo(tX(scaleX_Min), tY(yStart));
        ctx.lineTo(tX(scaleX_Max), tY(yEnd));
        ctx.stroke();
        
        // Dots
        function drawDot(res, color, label) {
            if (res && res.dist < scaleX_Max && res.dist > scaleX_Min) {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(tX(res.dist), tY(res.trueAlt), 5, 0, Math.PI*2);
                ctx.fill();
                ctx.fillText(label, tX(res.dist)+5, tY(res.trueAlt)+15);
            }
        }

        drawDot(rHigh, "#ffd700", "3 WHT");
        drawDot(rLow, "#ef233c", "3 RED");
        drawDot(rVeryLow, "#880e4f", "4 RED");
    }

    function toRad(deg) { return deg * Math.PI / 180; }

    updateSimulation();
</script>
</body>
</html>